<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calendário de Reservas</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 2rem;
      background-color: #f8f8f8;
      color: #333;
    }
    .calendar-container {
      max-width: 360px;
      margin: 0 auto;
      background-color: white;
      border-radius: 12px;
      padding: 1rem;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.3rem;
    }
    .day, .weekday {
      width: 42px;
      height: 42px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .weekday {
      font-weight: bold;
      color: #888;
    }
    .day.available {
      background-color: white;
    }
    .day.unavailable, .day.past {
      background-color: #e0e0e0;
      color: #999;
      pointer-events: none;
    }
    .day.selected, .day.in-range {
      background-color: #006d45;
      color: white;
    }
    .calendar-footer {
      margin-top: 1rem;
      text-align: center;
    }
    select {
      padding: 0.5rem;
      margin-top: 0.5rem;
      border-radius: 8px;
    }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="calendar-container">
    <div class="calendar-header">
      <button id="prevMonth">◀</button>
      <h3 id="monthYear"></h3>
      <button id="nextMonth">▶</button>
    </div>
    <div class="calendar-grid" id="calendarWeekdays"></div>
    <div class="calendar-grid" id="calendarDays"></div>
    <div class="calendar-footer">
      <div>
        <label>Hóspedes (até 12):
          <select id="guests">
            ${[...Array(13).keys()].map(i => `<option value="${i}">${i}</option>`).join('')}
          </select>
        </label>
      </div>
      <div>
        <label>Pets (até 2):
          <select id="pets">
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
          </select>
        </label>
      </div>
      <div id="totalValue">Total: R$ 0,00</div>
    </div>
  </div>

  <script>
    const calendarDays = document.getElementById('calendarDays');
    const calendarWeekdays = document.getElementById('calendarWeekdays');
    const monthYear = document.getElementById('monthYear');
    const prevMonthBtn = document.getElementById('prevMonth');
    const nextMonthBtn = document.getElementById('nextMonth');
    const totalValueDisplay = document.getElementById('totalValue');
    const guestsSelect = document.getElementById('guests');
    const petsSelect = document.getElementById('pets');

    let currentDate = new Date();
    let selectedStart = null;
    let selectedEnd = null;
    let availabilityData = {};

    const weekdays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];

    weekdays.forEach(d => {
      const day = document.createElement('div');
      day.className = 'weekday';
      day.textContent = d;
      calendarWeekdays.appendChild(day);
    });

    function formatDate(date) {
      return date.toISOString().split('T')[0];
    }

    async function fetchAvailability() {
      const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRbZUZD_RuGjPaw7LhV1bJzQT0tX7vndih4VuOlm4pEJ6LktEgiyL7p-fiXh2iewxX3-WpqkB4iaFIL/pub?gid=0&single=true&output=csv';
      const response = await fetch(csvUrl);
      const text = await response.text();
      const rows = text.trim().split('\n').slice(1);
      rows.forEach(row => {
        const [data, disponivel, valor] = row.split(',');
        availabilityData[data] = {
          disponivel: disponivel.trim().toLowerCase() === 'sim',
          valor: parseFloat(valor.replace('R$', '').replace(',', '.')) || 0
        };
      });
      renderCalendar();
    }

    function renderCalendar() {
      calendarDays.innerHTML = '';

      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);

      monthYear.textContent = `${firstDay.toLocaleString('default', { month: 'long' })} de ${year}`;

      for (let i = 0; i < firstDay.getDay(); i++) {
        const blank = document.createElement('div');
        calendarDays.appendChild(blank);
      }

      for (let d = 1; d <= lastDay.getDate(); d++) {
        const dayDate = new Date(year, month, d);
        const isoDate = formatDate(dayDate);
        const day = document.createElement('div');
        day.className = 'day';

        const isPast = dayDate < new Date(new Date().toDateString());
        const data = availabilityData[isoDate];
        const isAvailable = data?.disponivel;

        if (isPast) day.classList.add('past');
        else if (!isAvailable) day.classList.add('unavailable');
        else day.classList.add('available');

        if (selectedStart && selectedEnd && dayDate >= selectedStart && dayDate <= selectedEnd) {
          day.classList.add(dayDate.getTime() === selectedStart.getTime() || dayDate.getTime() === selectedEnd.getTime() ? 'selected' : 'in-range');
        }

        day.textContent = d;

        if (!isPast && isAvailable) {
          day.onclick = () => selectDate(dayDate);
        }

        calendarDays.appendChild(day);
      }
    }

    function selectDate(date) {
      if (!selectedStart || selectedEnd) {
        selectedStart = date;
        selectedEnd = null;
      } else if (date > selectedStart) {
        selectedEnd = date;
      } else {
        selectedStart = date;
        selectedEnd = null;
      }
      renderCalendar();
      updateTotal();
    }

    function updateTotal() {
      if (!selectedStart || !selectedEnd) {
        totalValueDisplay.textContent = 'Total: R$ 0,00';
        return;
      }

      let total = 0;
      let tempDate = new Date(selectedStart);

      while (tempDate <= selectedEnd) {
        const iso = formatDate(tempDate);
        if (availabilityData[iso]?.disponivel) {
          total += availabilityData[iso].valor;
        }
        tempDate.setDate(tempDate.getDate() + 1);
      }

      const guests = parseInt(guestsSelect.value);
      const pets = parseInt(petsSelect.value);

      const nights = Math.ceil((selectedEnd - selectedStart) / (1000 * 60 * 60 * 24));
      const extraGuests = guests > 10 ? guests - 10 : 0;
      total += extraGuests * 150 * nights;
      if (pets > 0) total += 150;

      totalValueDisplay.textContent = `Total: R$ ${total.toFixed(2).replace('.', ',')}`;
    }

    prevMonthBtn.onclick = () => {
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderCalendar();
    };

    nextMonthBtn.onclick = () => {
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderCalendar();
    };

    fetchAvailability();
  </script>
</body>
</html>
